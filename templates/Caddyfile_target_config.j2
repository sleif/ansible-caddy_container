{{ caddy_target_uri }} {
    encode gzip

    # import from global Caddyfile
    import accesslog
    {% if caddy_basicauth_user is defined and caddy_basicauth_user is truthy %}
    basicauth {{ caddy_basicauth_matcher | d('*') }} {
        {{ caddy_basicauth_user }} {{ caddy_basicauth_password | string |
          password_hash(hashtype='bcrypt',salt=caddy_target_uri | hash('sha1') | regex_replace('(.{22}).*', '\\1')) }}
    }
    {% endif %}
    {# import errorhandling
    import wellknown #}

    {# handle * { #}
    {% if caddy_operation == 'caddy_reverse_proxy' %}
    reverse_proxy {{ caddy_reverse_proxy_src }}:{{ caddy_reverse_proxy_src_port }}
    header /* {
        {% for line in caddy_proxy_config_header_lines | d([]) %}
        {{ line }}
        {% endfor %}
        {# Strict-Transport-Security "max-age=15552000; includeSubDomains" #}
        {# Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" #}
        {# X-Content-Type-Options nosniff always #}
        {# X-Xss-Protection "1; mode=block" always #}
        {# X-Frame-Options "SAMEORIGIN" always #}
    }
    {% for line in caddy_proxy_config_lines | d([]) %}
    {{ line }}
    {% endfor %}
    {% endif %}

    {% if caddy_operation == 'caddy_file_server' %}
    handle * {
        root * {{ _caddy_file_server_root }}
        file_server
    }
	{# tls {
		protocols tls1.3
		curves x25519
	}
	encode zstd gzip #}
    {% endif %}
}
